#!/usr/bin/env python 
#coding: utf-8

'''_____________________________________________________________________________________________________________________________________________________________

                                                                      NHAI_TOLL_PRICES SCRIPT
________________________________________________________________________________________________________________________________________________________________
'''

import io
import requests
import pandas as pd
import numpy as np
import sqlalchemy 
from bs4 import BeautifulSoup
  

def toll_prices():
    
        pages = []

        TOLL_NAME = []
        
        TOLL_STATE = []

        BUS_TRUCK = []

        THREE_AXLE = []

        collection = [
                                    4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,
                                    24,25,26,27,28,29,30,31,34,35,39,40,41,43,44,45,47,48,
                                    49,50,56,57,58,59,61,64,66,67,68,70,71,72,73,74,75,76,
                                    77,79,80,82,84,85,86,87,88,89,90,92,95,96,97,98,99,100,
                                    101,102,103,104,105,106,107,108,109,110,111,112,113,114,
                                    115,116,117,118,119,120,121,123,124,125,129,130,131,132,
                                    133,134,135,136,137,138,139,140,141,142,143,144,145,146,
                                    147,148,149,150,151,152,153,154,155,156,157,158,159,160,
                                    161,162,163,164,165,166,168,169,170,171,172,173,174,175,
                                    176,177,178,179,180,181,182,183,184,185,186,187,188,189,
                                    190,191,193,194,195,197,199,200,201,202,203,204,205,207,
                                    208,209,210,211,212,213,214,215,216,217,218,219,220,222,
                                    223,224,225,226,227,228,229,230,231,232,233,235,236,237,
                                    238,239,240,242,243,244,245,246,247,248,250,251,252,253,
                                    255,256,257,258,259,260,261,262,263,264,265,266,267,269,
                                    270,271,272,273,275,279,280,281,282,283,284,285,286,287,
                                    288,289,290,291,292,294,295,296,298,299,300,301,302,303,
                                    304,305,306,308,309,310,311,312,313,314,315,316,321,324,
                                    326,330,333,338,339,340,341,342,343,344,345,346,347,348,
                                    349,350,351,352,353,354,357,358,359,360,362,363,364,366,
                                    367,368,370,371,373,374,375,376,377,379,380,381,384,385,
                                    386,387,388,389,394,395,396,397,398,400,401,402,403,405,
                                    406,408,409,410,411,412,413,414,415,416,417,418,419,420,
                                    421,422,423,424,425,426,427,428,429,430,431,432,433,434,
                                    438,439,440,441,442,443,444,445,446,447,448,450,451,452,
                                    453,454,455,456,457,458,459,460,461,462,464,465,466,467,
                                    468,469,470,471,472,473,474,475,476,477,478,479,480,481,
                                    482,483,484,485,486,487,488,489,490,491,492,493,1476,1477,
                                    1478,1479,4480,4481,4482,4483,4484,4485,4486,4489,4490,4491,
                                    4492,4493,4494,4495,4496,4497,4498,4499,4500,4501,4502,4503,
                                    4504,4505,4506,4507,4508,4509,4510,4511,4512,4513,4515,4520,
                                    4536,4537,4538,4539,4540,4541,4542,4543,4544,4545,4546,4547,
                                    4548,4549,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,
                                    4560,4561,4562,4563,4566,4567,4568,4569,4570,4571,4572,4573,
                                    4574,4575,4576,4577,4578,4579,4580,4581,4582,4583,4584,4585,
                                    4586,4588,4589,4590,4591,4592,4593,4594,4595,4596,4597,4598,
                                    4599,4600,4601,4602,4603,4604,4605,4606,4607,4608,4609,4611,
                                    4612,4613,4614,4615,4617,4618,4619,4620,4621,4622,4623,4626,
                                    4627,4628,4629,5626,5627,5628,5629,5630,5631,5632,5633,5634,
                                    5636,5637,5638,5639,5640,5641,5642,
                     ]


        for i in collection:
            url = "http://tis.nhai.gov.in/TollInformation?TollPlazaID=" + str(i)
            pages.append(url)

        for item in pages:
            page = requests.get(item)
            soup = BeautifulSoup(page.text, 'html.parser')


            for container in soup.find_all("div", class_ = "PA15"):

                TOLL_NAME.append(container.find_all('b')[0].text.strip())
                
                TOLL_STATE.append(container.find_all('b')[1].text.strip())

                BUS_TRUCK.append(container.find_all('tr')[5].text.strip())

                THREE_AXLE.append(container.find_all('tr')[7].text.strip())


        df = pd.DataFrame({'TOLL_NAME': TOLL_NAME,
                           'TOLL_STATE': TOLL_STATE,
                           'UPTO_2_AXLE': BUS_TRUCK,
                           'UPTO_3_AXLE' : THREE_AXLE
                          })


        df_1 = df['UPTO_2_AXLE'].str.split(" ",n = 0, expand = True)

        df_2 = df['UPTO_3_AXLE'].str.split(" ",n = 0, expand = True)


        df['TOLL_STATE'] = df['TOLL_STATE'].str.replace('Stretch :','')
        
        df['UPTO_2_AXLE'] = df_1[0].str.replace('Bus/Truck','')

        df['UPTO_3_AXLE'] = df_2[3].str.replace('Vehicle','')
        
        df['UPTO_2_AXLE'] = df['UPTO_2_AXLE'].astype(float).replace(np.nan, 0).astype(int)
        
        df['UPTO_3_AXLE'] = df['UPTO_3_AXLE'].astype(float).replace(np.nan, 0).astype(int)
        

        engine = sqlalchemy.create_engine("oracle://xpscore:abc@124.7.209.92:1521/ORCL", echo = True)
        
        con = engine.connect()
        
        table_name = 'nhai_toll_prices'
        
        df.to_sql(table_name, con, if_exists = 'replace',
                  dtype={'TOLL_NAME': sqlalchemy.types.VARCHAR(length=255),
                         'TOLL_STATE': sqlalchemy.types.VARCHAR(length=255),
                         'UPTO_2_AXLE': sqlalchemy.types.INTEGER,
                         'UPTO_3_AXLE': sqlalchemy.types.INTEGER
                        },
                  index = False)
        
if __name__ == '__main__':
    toll_prices()